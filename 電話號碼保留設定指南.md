# 📱 電話號碼完整保留設定指南

## ❌ 問題說明

當同業借出輸入十碼電話（例如：`0912-345-678`）後，到 Google Sheets 新增時會少了前面的 0，變成 `912-345-678`。

即使將 Sheets 列設定為「純文本」格式，透過 API 寫入時 Google 還是會自動轉換數字。

---

## ✅ 完整解決方案

### 步驟 1：更新 Google Apps Script 代码

1. **開啟 Google Sheets**
2. 點擊上方選單：**擴充功能** → **Apps Script**
3. **完整替換**為 `GoogleAppsScript示例.js` 中的代碼
4. **重要修改點**：

```javascript
function saveKeyRecord(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAMES.KEYS);
  
  // ... 省略其他代碼 ...
  
  // ⭐⭐⭐ 關鍵 1：使用 colleaguePhoneForSheets 字段
  const phone = record.colleaguePhoneForSheets || record.colleaguePhone || '';
  
  if (action === 'borrow') {
    const newRow = sheet.getLastRow() + 1;
    
    // ⭐⭐⭐ 關鍵 2：先設置該行的電話號碼格式為文本
    sheet.getRange(newRow, 6).setNumberFormat('@STRING@');
    
    // 寫入數據
    sheet.appendRow([
      record.id,
      record.borrowTime,
      record.borrowerType === 'member' ? '成員' : '同業',
      record.memberId || '',
      record.borrowerType === 'member' ? record.memberName : record.colleagueName,
      phone,  // 使用帶單引號的電話號碼
      record.keyItem,
      '借出中',
      '', '', ''
    ]);
    
    // ⭐⭐⭐ 關鍵 3：去掉單引號後再次設置值
    if (phone) {
      const phoneCell = sheet.getRange(newRow, 6);
      phoneCell.setNumberFormat('@STRING@');
      const cleanPhone = phone.startsWith("'") ? phone.substring(1) : phone;
      phoneCell.setValue(cleanPhone);
    }
    
    return { status: 'success', message: '借出記錄已保存' };
  }
}
```

### 步驟 2：重新部署 Web App

1. 點擊右上角 **「部署」** → **「管理部署」**
2. 點擊現有部署旁的 **「編輯」** 圖標（筆形圖標）
3. 在「版本」下拉選單中選擇 **「新版本」**
4. 點擊 **「部署」**
5. **重要**：複製新的 Web App URL（如果 URL 改變了）

### 步驟 3：更新前端 URL（如果需要）

如果 Web App URL 改變了，需要更新 `script.js` 中的 URL：

```javascript
// script.js 第 34 行
const GOOGLE_SHEETS_WEB_APP_URL = '你的新URL';
```

---

## 🔍 三個關鍵技術點

### 1️⃣ 前端發送時加單引號

```javascript
// script.js
const phoneForSheets = borrowerInfo.colleaguePhone 
  ? `'${borrowerInfo.colleaguePhone}` 
  : null;

const keyRecord = {
  // ...
  colleaguePhone: borrowerInfo.colleaguePhone,  // 原始格式
  colleaguePhoneForSheets: phoneForSheets,      // 帶單引號
  // ...
};
```

### 2️⃣ Google Apps Script 先設置格式

```javascript
// 在寫入前先設置單元格格式
sheet.getRange(newRow, 6).setNumberFormat('@STRING@');
```

`@STRING@` 是 Google Sheets 的特殊格式代碼，強制將內容視為純文本。

### 3️⃣ 去除單引號後設置值

```javascript
// 去掉前面的單引號
const cleanPhone = phone.startsWith("'") ? phone.substring(1) : phone;
phoneCell.setValue(cleanPhone);
```

---

## 📊 數據流程圖

```
用戶輸入
  0912-345-678
       ↓
前端處理
  colleaguePhone: "0912-345-678"
  colleaguePhoneForSheets: "'0912-345-678"
       ↓
發送到 Google Apps Script
  JSON: { colleaguePhoneForSheets: "'0912-345-678" }
       ↓
Apps Script 處理
  1. 設置格式：setNumberFormat('@STRING@')
  2. 去除單引號：substring(1) → "0912-345-678"
  3. 寫入值：setValue("0912-345-678")
       ↓
Google Sheets 顯示
  0912-345-678 ✅ (完整十碼)
```

---

## 🧪 測試方法

### 方法 1：使用 Apps Script 測試函數

在 Apps Script 編輯器中執行 `testPhoneNumber()` 函數：

1. 在 Apps Script 編輯器頂部選擇函數：`testPhoneNumber`
2. 點擊 **「執行」**
3. 查看新建立的「測試」工作表
4. 觀察三種方法的結果差異

### 方法 2：實際測試借出流程

1. 在網站上選擇「同業借出」
2. 輸入完整十碼電話：`0912-345-678`
3. 登記借出
4. 檢查 Google Sheets 中的「鑰匙借還記錄」工作表
5. 確認電話號碼列顯示為 `0912-345-678`（十碼）

---

## ❓ 常見問題

### Q1：我已經設定純文本了，為什麼還是會少 0？

**A**：通過 `appendRow()` 或 API 寫入時，Google Sheets 會自動判斷數據類型。單純設置列格式不夠，必須在寫入**前**設置單元格格式。

### Q2：為什麼要用單引號？

**A**：單引號是告訴 Google Sheets「這是文本」的傳統方法。在前端加單引號，後端再去除，可以確保傳輸過程中數據類型不變。

### Q3：需要修改現有的 Sheets 數據嗎？

**A**：建議手動修正歷史數據：
1. 選擇電話號碼列
2. 格式 → 數字 → 純文本
3. 在缺少 0 的號碼前手動加上 0

### Q4：測試時發現還是少 0，怎麼辦？

**檢查清單**：
- [ ] Google Apps Script 代碼是否完整替換
- [ ] 是否重新部署了新版本
- [ ] 前端是否清除快取（Ctrl + F5）
- [ ] 是否使用了 `colleaguePhoneForSheets` 字段
- [ ] 電話號碼列（第 6 列）是否設置了 `@STRING@` 格式

---

## 📝 完整檢查清單

### 前端（已完成 ✅）
- [x] 新增 `cleanPhoneNumber()` 函數
- [x] 發送時使用 `colleaguePhoneForSheets` 字段
- [x] 讀取時自動清理單引號

### 後端（需要設置 ⚠️）
- [ ] 複製 `GoogleAppsScript示例.js` 代碼到 Apps Script
- [ ] 修改工作表名稱（如果不同）
- [ ] 重新部署 Web App（選擇「新版本」）
- [ ] 測試電話號碼是否正確保存

### 驗證（測試完成後 ✅）
- [ ] 新增同業借出，確認十碼完整
- [ ] 查看 Sheets，確認沒有少 0
- [ ] 從 Sheets 讀取，確認顯示完整

---

## 💡 技術原理說明

### 為什麼 Google Sheets 會自動轉換？

Google Sheets 使用智能類型識別：
- 看到 `0912345678` → 識別為數字 → 轉換為 `912345678`
- 看到 `0912-345-678` → 識別為文本 → 保留原樣（但有時也會轉換）

### 為什麼設置格式還不夠？

使用 `appendRow()` 時：
```javascript
// ❌ 錯誤：數據已經寫入後才設置格式
sheet.appendRow([..., '0912345678', ...]);
sheet.getRange(row, 6).setNumberFormat('@STRING@');  // 太遲了

// ✅ 正確：寫入前先設置格式
sheet.getRange(row, 6).setNumberFormat('@STRING@');
sheet.getRange(row, 6).setValue('0912345678');
```

### 最佳實踐

1. **雙重保護**：前端加單引號 + 後端設置格式
2. **立即驗證**：寫入後立即讀取確認
3. **格式統一**：建議使用 `0912-345-678` 格式（含破折號）

---

## 📞 支援

如果按照以上步驟操作後還有問題，請檢查：
1. 瀏覽器控制台（F12）是否有錯誤訊息
2. Google Apps Script 執行記錄（查看 → 執行記錄）
3. Google Sheets 的執行記錄（擴充功能 → Apps Script → 執行記錄）

---

**更新日期**：2025/10/15  
**版本**：v2.1

