# 🔍 排班表讀取診斷指南

## ✅ 系統自動讀取功能（已存在）

系統**已經有**自動讀取功能：
- 📥 頁面載入 1 秒後自動讀取排班表
- 🔄 每 5 分鐘自動檢查更新
- 🔄 切換月份時自動同步
- 🔄 頁面重新獲得焦點時檢查更新

**代碼位置**：`script.js` 第 5694-5703 行

---

## 🧪 測試 1：檢查控制台訊息

### 操作步驟
1. 按 `F12` 打開瀏覽器控制台
2. 按 `Ctrl + F5` 強制刷新頁面
3. 查看控制台訊息

### ✅ 正常情況（成功讀取）
```
🔄 正在自動從 Google Sheets 載入資料...
🔄 正在從 Google Sheets 載入最新班表...
✅ 已自動載入最新班表
```

### ❌ 異常情況 1：後端代碼未更新
```
🔄 正在自動從 Google Sheets 載入資料...
🔄 正在從 Google Sheets 載入最新班表...
❌ 讀取失敗: 未知的操作
```
**原因**：Google Apps Script 後端代碼還是舊版本  
**解決**：更新 Google Apps Script 代碼（見下方）

### ❌ 異常情況 2：網絡或權限問題
```
🔄 正在自動從 Google Sheets 載入資料...
❌ 載入排班資料超時
```
或者
```
❌ 讀取排班資料錯誤: [錯誤信息]
```
**原因**：網絡問題或 Apps Script 權限設置錯誤  
**解決**：檢查網絡連接和 Apps Script 部署設置

### ❌ 異常情況 3：URL 未設置
```
⚠️ Google Sheets Web App URL 尚未設定
```
**原因**：script.js 中的 URL 不正確  
**解決**：確認 URL 正確（目前應該是 AKfycbzmz2hiv...）

---

## 🧪 測試 2：直接測試 Web App API

在瀏覽器中訪問以下 URL：

### 測試排班表 API
```
https://script.google.com/macros/s/AKfycbzmz2hiv-8oLhSctsWE-XYK9Xnrbe8l6v2Jw1uenq1vStVQNydWdDoJaXBGXByK3GyKZA/exec?action=getSchedule&callback=test
```

### ✅ 成功返回
```javascript
test({"status":"success","recordCount":0,"data":[]})
// recordCount: 0 表示目前沒有排班記錄
// recordCount: X 表示有 X 筆記錄
```

### ❌ 失敗返回
```javascript
test({"status":"error","message":"未知的操作"})
```
→ **確認：後端代碼沒有更新！**

---

## 🔧 解決方案：更新 Google Apps Script

### 步驟 1：確認當前 Apps Script 代碼

1. 打開 Google Sheets（常順地產排班表）
2. 點擊：**擴充功能** → **Apps Script**
3. 檢查代碼中是否有以下函數：
   - `function doGet(e)`
   - `function doPost(e)`
   - `function getSchedule(yearMonth)`
   - `function getKeyRecords()`

### 如果沒有這些函數 → 需要更新！

### 步驟 2：更新代碼

1. 打開本地文件：**`GoogleAppsScript示例.js`**
2. 全選複製（Ctrl + A → Ctrl + C）
3. 回到 Apps Script 編輯器
4. 全選現有代碼（Ctrl + A）
5. 貼上新代碼（Ctrl + V）
6. 點擊 **保存** 💾

### 步驟 3：確認部署設置（不需要重新部署）

1. 點擊：**部署** → **管理部署**
2. 確認設置：
   - ✅ 類型：網頁應用程式
   - ✅ 執行身份：**我**
   - ✅ 有權使用者：**所有人**

### 步驟 4：等待生效

⏰ 保存後等待約 **1-2 分鐘**讓 Google 更新服務器

### 步驟 5：重新測試

1. 重新訪問測試 URL（見上方測試 2）
2. 確認返回 `{"status":"success",...}`
3. 回到網站，按 `Ctrl + F5` 刷新
4. 按 `F12` 查看控制台，應該看到成功訊息

---

## 🧪 測試 3：手動同步測試

如果自動讀取還是有問題，可以測試手動同步：

1. 在網站上方選擇當月（例如：2025-01）
2. 點擊管理功能 → **「📥 從 Sheets 同步」**（需要密碼）
3. 輸入密碼：`10108888`
4. 查看是否能成功同步

### ✅ 成功
```
✅ 已從 Google Sheets 同步 X 筆排班記錄
```

### ❌ 失敗
```
❌ Google Sheets 中沒有排班記錄
```
或
```
⚠️ Google Sheets Web App URL 尚未設定
```

---

## 📊 系統讀取流程圖

```
頁面載入
   ↓
等待 1 秒
   ↓
調用 autoRefreshFromSheets()
   ↓
讀取當前月份（monthPicker.value）
   ↓
發送請求到 Google Apps Script
   URL + ?action=getSchedule&yearMonth=2025-01
   ↓
Google Apps Script 處理
   ├─ ✅ 代碼正確 → 返回排班數據
   └─ ❌ 代碼舊版 → 返回 "未知的操作"
   ↓
前端接收數據
   ├─ ✅ 有數據 → 保存到 localStorage → 顯示
   ├─ ❌ 無數據 → 顯示 "沒有排班記錄"
   └─ ❌ 錯誤  → 顯示錯誤信息
```

---

## ✅ 完成檢查清單

### 後端（Google Apps Script）
- [ ] 已複製 `GoogleAppsScript示例.js` 代碼到 Apps Script
- [ ] 已保存代碼
- [ ] 測試 URL 返回 `status: "success"`
- [ ] 部署設置：執行身份為「我」
- [ ] 部署設置：有權使用者為「所有人」

### 前端（網站）
- [ ] URL 已更新為最新的（AKfycbzmz2hiv...）
- [ ] 強制刷新頁面（Ctrl + F5）
- [ ] 控制台顯示「✅ 已自動載入最新班表」
- [ ] 排班表格正常顯示

### Google Sheets
- [ ] 工作表「排班表」已存在
- [ ] 工作表有表頭：年月、日期、成員編號、成員姓名、更新時間
- [ ] 如果有排班數據，確認格式正確

---

## 🆘 常見問題

### Q1：測試 URL 一直返回錯誤
**A**：確認是否已經保存並等待 1-2 分鐘。如果還是錯誤，嘗試重新部署（選擇「新版本」）。

### Q2：控制台沒有任何訊息
**A**：檢查是否按了 Ctrl + F5 強制刷新，而不是普通刷新。

### Q3：顯示「已自動載入」但表格是空的
**A**：這是正常的，表示 Google Sheets 中目前沒有排班記錄。需要先手動排班或使用「隨機平均排班」功能。

### Q4：手動同步可以，但自動讀取不行
**A**：可能是瀏覽器快取問題，嘗試：
1. 清除網站快取
2. 使用無痕模式測試
3. 檢查是否有瀏覽器擴充功能阻擋

### Q5：其他視窗可以讀取，但這個視窗不行
**A**：localStorage 可能損壞，按 F12 → Application → Local Storage → 右鍵 → Clear，然後刷新。

---

## 📞 需要幫助？

如果按照以上步驟操作後還是無法讀取，請提供：

1. **控制台截圖**（F12 → Console）
2. **測試 URL 的返回結果**（複製貼上）
3. **Google Sheets 工作表名稱**（確認是否叫「排班表」）
4. **是否有排班數據**（Sheets 中有幾筆記錄）

這樣可以更準確地診斷問題！

---

**更新日期**：2025/10/15  
**版本**：v2.1

